<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Library.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Modul glowny aplikacji - klasa Main z metoda main</a> &gt; <a href="index.source.html" class="el_package">pl.edu.agh.kis.pz1</a> &gt; <span class="el_source">Library.java</span></div><h1>Library.java</h1><pre class="source lang-java linenums">package pl.edu.agh.kis.pz1;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.ArrayList;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.Semaphore;
import java.util.logging.ConsoleHandler;
import java.util.logging.Formatter;
import java.util.logging.LogRecord;
import java.util.logging.Logger;

/**
 * Klasa reprezentująca bibliotekę.
 */
public class Library {
    /**
     * Logger biblioteki.
     */
<span class="fc" id="L21">    final Logger logger = Logger.getLogger(Library.class.getName());</span>

    /**
     * Formatter loggera.
     */
<span class="fc" id="L26">    static class CustomRecordFormatter extends Formatter {</span>
        @Override
        public String format(final LogRecord r) {
<span class="nc" id="L29">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L30">            sb.append(formatMessage(r)).append(System.getProperty(&quot;line.separator&quot;));</span>
<span class="nc bnc" id="L31" title="All 2 branches missed.">            if (null != r.getThrown()) {</span>
<span class="nc" id="L32">                sb.append(&quot;Throwable occurred: &quot;);</span>
<span class="nc" id="L33">                Throwable t = r.getThrown();</span>
<span class="nc" id="L34">                try (StringWriter sw = new StringWriter(); PrintWriter pw = new PrintWriter(sw)) {</span>
<span class="nc" id="L35">                    t.printStackTrace(pw);</span>
<span class="nc" id="L36">                    sb.append(sw);</span>
<span class="nc" id="L37">                } catch (Exception ex) {</span>
                    // ignore all exceptions here
<span class="nc" id="L39">                }</span>
            }
<span class="nc" id="L41">            return sb.toString();</span>
        }
    }

    /**
     * Zmienna przełączająca tryb debugowania.
     */
<span class="fc" id="L48">    boolean debugMode = false;</span>
    /**
     * Zmienna przechwująca łańcuch znaków w trybie debugowania, który byłby wypisany na konsolę.
     */
<span class="fc" id="L52">    StringBuilder debugStringBuilder = new StringBuilder();</span>
    /**
     * Maksymalna ilość iteracji w trybie debugowania.
     */
    int debugMaxIterations;
    /**
     * Semafor synchronizujący dodawanie tekstu do łańcucha znaków w trybie debugowania.
     */
<span class="fc" id="L60">    final Semaphore debugSemaphore = new Semaphore(1);</span>

    /**
     * Zmienna określająca czy biblioteka powinna zakończyć działanie.
     */
<span class="fc" id="L65">    boolean shouldEnd = false;</span>

    /**
     * Maksymalna ilość miejsc w bibliotece dla czytelników.
     */
    int maxReaders;

    /**
     * Obecna ilość pisarzy w bibliotece.
     */
<span class="fc" id="L75">    int writersCount = 0;</span>
    /**
     * Obecna ilość czytelników w bibliotece.
     */
<span class="fc" id="L79">    int readersCount = 0;</span>

    /**
     * Semafor dla miejsc w bibliotece.
     */
    Semaphore readerAndWriterSemaphore;
    /**
     * Semafor dla bibliotekarza.
     */
<span class="fc" id="L88">    Semaphore librarySemaphore = new Semaphore(0);</span>

    /**
     * Kolejka zapisująca kolejność wejścia czytelników i pisarzy do biblioteki.
     */
<span class="fc" id="L93">    BlockingQueue&lt;Human&gt; waitingQueue = new LinkedBlockingQueue&lt;&gt;();</span>

    /**
     * Lista zapisanych czytelników i pisarzy w bibliotece.
     */
<span class="fc" id="L98">    ArrayList&lt;Human&gt; humans = new ArrayList&lt;&gt;();</span>

    /**
     * Konstruktor biblioteki.
     * @param maxReadersArg Maksymalna ilość miejsc w bibliotece dla czytelników.
     * @param debugModeArg Zmienna przełączająca tryb debugowania.
     */
<span class="fc" id="L105">    public Library(int maxReadersArg, boolean debugModeArg) {</span>
<span class="fc" id="L106">        maxReaders = maxReadersArg;</span>

<span class="fc" id="L108">        debugMode = debugModeArg;</span>
<span class="fc" id="L109">        debugMaxIterations = 1;</span>

<span class="fc" id="L111">        createSemaphoreAndConfigureLogger();</span>
<span class="fc" id="L112">    }</span>

    /**
     * Metoda tworząca semafor dla miejsc w bibliotece i konfigurująca logger.
     */
    void createSemaphoreAndConfigureLogger() {
<span class="fc" id="L118">        readerAndWriterSemaphore = new Semaphore(maxReaders);</span>

<span class="fc" id="L120">        logger.setUseParentHandlers(false);</span>
<span class="fc" id="L121">        ConsoleHandler consoleHandler = new ConsoleHandler();</span>
<span class="fc" id="L122">        consoleHandler.setFormatter(new CustomRecordFormatter());</span>
<span class="fc" id="L123">        logger.addHandler(consoleHandler);</span>
<span class="fc" id="L124">    }</span>

    /**
     * Metoda dodająca czytelnika lub pisarza do biblioteki.
     * @param human Czytelnik lub pisarz do dodania.
     */
    public void addHuman(Human human) {
<span class="fc" id="L131">        humans.add(human);</span>

<span class="fc" id="L133">        debugMaxIterations++;</span>
<span class="fc" id="L134">    }</span>

    /**
     * Metoda ustawiająca tryb debugowania.
     * @param debugModeArg
     */
    public void setDebugMode(boolean debugModeArg) {
<span class="nc" id="L141">        debugMode = debugModeArg;</span>
<span class="nc" id="L142">    }</span>

    /**
     *
     * @return
     */
    public boolean getDebugMode() {
<span class="nc" id="L149">        return debugMode;</span>
    }

    public void setDebugMaxIterations(int debugMaxIterationsArg) {
<span class="nc" id="L153">        debugMaxIterations = debugMaxIterationsArg;</span>
<span class="nc" id="L154">    }</span>

    public int getDebugMaxIterations() {
<span class="nc" id="L157">        return debugMaxIterations;</span>
    }

    public String getDebugString() {
<span class="fc" id="L161">        return debugStringBuilder.toString();</span>
    }

    public void resetDebugString() {
<span class="nc" id="L165">        debugStringBuilder = new StringBuilder();</span>
<span class="nc" id="L166">    }</span>

    void printQueueInfo() {
<span class="fc" id="L169">        StringBuilder sb = new StringBuilder();</span>

<span class="fc" id="L171">        sb.append(&quot;------ Queue info ------&quot;);</span>
<span class="fc" id="L172">        sb.append(&quot;\nWaiting queue size: &quot;);</span>
<span class="fc" id="L173">        sb.append(waitingQueue.size());</span>
<span class="fc" id="L174">        sb.append(&quot;\nReaders count: &quot;);</span>
<span class="fc" id="L175">        sb.append(readersCount);</span>
<span class="fc" id="L176">        sb.append(&quot;\nWriters count: &quot;);</span>
<span class="fc" id="L177">        sb.append(writersCount);</span>
<span class="fc" id="L178">        sb.append(&quot;\n------ Queue info end ------&quot;);</span>

<span class="fc" id="L180">        writeToLoggerInfo(sb.toString());</span>
<span class="fc" id="L181">    }</span>

    private void processHumanInQueue(Human human) {
<span class="fc bfc" id="L184" title="All 2 branches covered.">        if (human.type == Human.HumanType.READER) {</span>
<span class="fc" id="L185">            readerAndWriterSemaphore.acquireUninterruptibly();</span>
<span class="fc" id="L186">            StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L187">            sb.append(human);</span>
<span class="fc" id="L188">            sb.append(&quot; is reading&quot;);</span>

<span class="fc" id="L190">            writeToLoggerInfo(sb.toString());</span>
<span class="fc" id="L191">            readersCount++;</span>
<span class="fc" id="L192">        } else {</span>
<span class="fc" id="L193">            readerAndWriterSemaphore.acquireUninterruptibly(maxReaders);</span>
<span class="fc" id="L194">            StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L195">            sb.append(human);</span>
<span class="fc" id="L196">            sb.append(&quot; is writing&quot;);</span>

<span class="fc" id="L198">            writeToLoggerInfo(sb.toString());</span>
<span class="fc" id="L199">            writersCount++;</span>
        }
<span class="fc" id="L201">        human.humanSemaphore.release();</span>
<span class="fc" id="L202">    }</span>

    public void processWaitingQueue() {
<span class="fc" id="L205">        int debugIterations = 0;</span>

<span class="pc bpc" id="L207" title="2 of 6 branches missed.">        while (!shouldEnd &amp;&amp; (!debugMode || debugIterations &lt; debugMaxIterations)) {</span>
<span class="fc" id="L208">            librarySemaphore.acquireUninterruptibly();</span>

<span class="pc bpc" id="L210" title="1 of 6 branches missed.">            while (!waitingQueue.isEmpty() &amp;&amp; (!debugMode || debugIterations &lt; debugMaxIterations)) {</span>
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">                if (debugMode) {</span>
<span class="fc" id="L212">                    debugIterations++;</span>
                }

<span class="fc" id="L215">                printQueueInfo();</span>

<span class="fc" id="L217">                Human human = waitingQueue.poll();</span>

<span class="pc bpc" id="L219" title="1 of 2 branches missed.">                if (human == null) {</span>
<span class="nc" id="L220">                    continue;</span>
                }

<span class="fc" id="L223">                processHumanInQueue(human);</span>
<span class="fc" id="L224">            }</span>
        }

<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (debugMode) {</span>
<span class="fc" id="L228">            stopLibrary();</span>
        }
<span class="fc" id="L230">    }</span>

    public void stopLibrary() {
<span class="fc" id="L233">        writeToLoggerInfo(&quot;Stopping library&quot;);</span>

<span class="fc bfc" id="L235" title="All 2 branches covered.">        for (Human human : humans) {</span>
<span class="fc" id="L236">            human.stopHuman();</span>
<span class="fc" id="L237">        }</span>

<span class="fc" id="L239">        shouldEnd = true;</span>
<span class="fc" id="L240">        waitingQueue.clear();</span>
<span class="fc" id="L241">        librarySemaphore.release(humans.size());</span>

<span class="fc" id="L243">        writeToLoggerInfo(&quot;Library stopped&quot;);</span>
<span class="fc" id="L244">    }</span>

    public void requestRead(Reader reader) {
<span class="fc" id="L247">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L248">        sb.append(reader);</span>
<span class="fc" id="L249">        sb.append(&quot; wants to read&quot;);</span>

<span class="fc" id="L251">        writeToLoggerInfo(sb.toString());</span>
<span class="fc" id="L252">        waitingQueue.add(reader);</span>

<span class="fc" id="L254">        librarySemaphore.release();</span>
<span class="fc" id="L255">        reader.humanSemaphore.acquireUninterruptibly();</span>
<span class="fc" id="L256">    }</span>

    public void requestWrite(Writer writer) {
<span class="fc" id="L259">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L260">        sb.append(writer);</span>
<span class="fc" id="L261">        sb.append(&quot; wants to write&quot;);</span>

<span class="fc" id="L263">        writeToLoggerInfo(sb.toString());</span>
<span class="fc" id="L264">        waitingQueue.add(writer);</span>

<span class="fc" id="L266">        librarySemaphore.release();</span>
<span class="fc" id="L267">        writer.humanSemaphore.acquireUninterruptibly();</span>
<span class="fc" id="L268">    }</span>

    public void finishRead(Reader reader) {
<span class="fc" id="L271">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L272">        sb.append(reader);</span>
<span class="fc" id="L273">        sb.append(&quot; finished reading&quot;);</span>

<span class="fc" id="L275">        writeToLoggerInfo(sb.toString());</span>

<span class="fc" id="L277">        readerAndWriterSemaphore.release();</span>
<span class="fc" id="L278">        readersCount--;</span>

<span class="fc" id="L280">        librarySemaphore.release();</span>
<span class="fc" id="L281">    }</span>

    public void finishWrite(Writer writer) {
<span class="fc" id="L284">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L285">        sb.append(writer);</span>
<span class="fc" id="L286">        sb.append(&quot; finished writing&quot;);</span>

<span class="fc" id="L288">        writeToLoggerInfo(sb.toString());</span>

<span class="fc" id="L290">        readerAndWriterSemaphore.release(maxReaders);</span>
<span class="fc" id="L291">        writersCount--;</span>

<span class="fc" id="L293">        librarySemaphore.release();</span>
<span class="fc" id="L294">    }</span>

    public void writeToLoggerInfo(String message) {
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">        if (debugMode) {</span>
<span class="fc" id="L298">            debugSemaphore.acquireUninterruptibly();</span>
<span class="fc" id="L299">            debugStringBuilder.append(message);</span>
<span class="fc" id="L300">            debugStringBuilder.append(&quot;\n&quot;);</span>
<span class="fc" id="L301">            debugSemaphore.release();</span>
<span class="nc bnc" id="L302" title="All 4 branches missed.">        } else if (logger != null &amp;&amp; logger.isLoggable(java.util.logging.Level.INFO)) {</span>
<span class="nc" id="L303">            logger.info(message);</span>
        }
<span class="fc" id="L305">    }</span>

    public void writeToLoggerSevere(String message) {
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (debugMode) {</span>
<span class="nc" id="L309">            debugSemaphore.acquireUninterruptibly();</span>
<span class="nc" id="L310">            debugStringBuilder.append(message);</span>
<span class="nc" id="L311">            debugStringBuilder.append(&quot;\n&quot;);</span>
<span class="nc" id="L312">            debugSemaphore.release();</span>
<span class="nc bnc" id="L313" title="All 4 branches missed.">        } else if (logger != null &amp;&amp; logger.isLoggable(java.util.logging.Level.SEVERE)) {</span>
<span class="nc" id="L314">            logger.severe(message);</span>
        }
<span class="nc" id="L316">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>