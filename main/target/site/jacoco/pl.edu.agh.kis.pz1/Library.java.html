<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Library.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Modul glowny aplikacji - klasa Main z metoda main</a> &gt; <a href="index.source.html" class="el_package">pl.edu.agh.kis.pz1</a> &gt; <span class="el_source">Library.java</span></div><h1>Library.java</h1><pre class="source lang-java linenums">package pl.edu.agh.kis.pz1;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.Vector;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.Semaphore;
import java.util.logging.ConsoleHandler;
import java.util.logging.Formatter;
import java.util.logging.LogRecord;
import java.util.logging.Logger;

public class Library {
<span class="nc" id="L15">    Logger logger = Logger.getLogger(Library.class.getName());</span>

    /**
     * Formatter for the logger.
     */
<span class="nc" id="L20">    static class CustomRecordFormatter extends Formatter {</span>
        @Override
        public String format(final LogRecord r) {
<span class="nc" id="L23">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L24">            sb.append(formatMessage(r)).append(System.getProperty(&quot;line.separator&quot;));</span>
<span class="nc bnc" id="L25" title="All 2 branches missed.">            if (null != r.getThrown()) {</span>
<span class="nc" id="L26">                sb.append(&quot;Throwable occurred: &quot;);</span>
<span class="nc" id="L27">                Throwable t = r.getThrown();</span>
<span class="nc" id="L28">                try (StringWriter sw = new StringWriter(); PrintWriter pw = new PrintWriter(sw)) {</span>
<span class="nc" id="L29">                    t.printStackTrace(pw);</span>
<span class="nc" id="L30">                    sb.append(sw.toString());</span>
<span class="nc" id="L31">                } catch (Exception ex) {</span>
                    // ignore all exceptions here
<span class="nc" id="L33">                }</span>
            }
<span class="nc" id="L35">            return sb.toString();</span>
        }
    }

<span class="nc" id="L39">    boolean shouldEnd = false;</span>

    int maxReaders;

<span class="nc" id="L43">    int writersCount = 0;</span>
<span class="nc" id="L44">    int readersCount = 0;</span>

    Semaphore readerAndWriterSemaphore;
<span class="nc" id="L47">    Semaphore librarySemaphore = new Semaphore(0);</span>

<span class="nc" id="L49">    BlockingQueue&lt;Human&gt; waitingQueue = new LinkedBlockingQueue&lt;&gt;();</span>

<span class="nc" id="L51">    Vector&lt;Human&gt; humans = new Vector&lt;&gt;();</span>

<span class="nc" id="L53">    public Library() {</span>
<span class="nc" id="L54">        maxReaders = 5;</span>

<span class="nc" id="L56">        createSemaphoreAndConfigureLogger();</span>
<span class="nc" id="L57">    }</span>

<span class="nc" id="L59">    public Library(int maxReadersArg) {</span>
<span class="nc" id="L60">        maxReaders = maxReadersArg;</span>

<span class="nc" id="L62">        createSemaphoreAndConfigureLogger();</span>
<span class="nc" id="L63">    }</span>

    void createSemaphoreAndConfigureLogger() {
<span class="nc" id="L66">        readerAndWriterSemaphore = new Semaphore(maxReaders);</span>

<span class="nc" id="L68">        logger.setUseParentHandlers(false);</span>
<span class="nc" id="L69">        ConsoleHandler consoleHandler = new ConsoleHandler();</span>
<span class="nc" id="L70">        consoleHandler.setFormatter(new CustomRecordFormatter());</span>
<span class="nc" id="L71">        logger.addHandler(consoleHandler);</span>
<span class="nc" id="L72">    }</span>

    public void addHuman(Human human) {
<span class="nc" id="L75">        humans.add(human);</span>
<span class="nc" id="L76">    }</span>

    void printQueueInfo() {
<span class="nc" id="L79">        StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L81">        sb.append(&quot;------ Queue info ------&quot;);</span>
<span class="nc" id="L82">        sb.append(&quot;\nWaiting queue size: &quot;);</span>
<span class="nc" id="L83">        sb.append(waitingQueue.size());</span>
<span class="nc" id="L84">        sb.append(&quot;\nReaders count: &quot;);</span>
<span class="nc" id="L85">        sb.append(readersCount);</span>
<span class="nc" id="L86">        sb.append(&quot;\nWriters count: &quot;);</span>
<span class="nc" id="L87">        sb.append(writersCount);</span>
<span class="nc" id="L88">        sb.append(&quot;\n------ Queue info end ------&quot;);</span>

<span class="nc" id="L90">        logger.info(sb.toString());</span>
<span class="nc" id="L91">    }</span>

    public void processWaitingQueue() {
<span class="nc bnc" id="L94" title="All 2 branches missed.">        while (!shouldEnd) {</span>
<span class="nc" id="L95">            librarySemaphore.acquireUninterruptibly();</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">            while (!waitingQueue.isEmpty()) {</span>
<span class="nc" id="L98">                printQueueInfo();</span>

<span class="nc" id="L100">                Human human = waitingQueue.poll();</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">                if (human == null) {</span>
<span class="nc" id="L103">                    continue;</span>
                }

<span class="nc bnc" id="L106" title="All 2 branches missed.">                if (human.type == Human.HumanType.READER) {</span>
<span class="nc" id="L107">                    readerAndWriterSemaphore.acquireUninterruptibly();</span>
<span class="nc" id="L108">                    logger.info(human.toString() + &quot; is reading&quot;);</span>
<span class="nc" id="L109">                    readersCount++;</span>
                } else {
<span class="nc" id="L111">                    readerAndWriterSemaphore.acquireUninterruptibly(maxReaders);</span>
<span class="nc" id="L112">                    logger.info(human.toString() + &quot; is writing&quot;);</span>
<span class="nc" id="L113">                    writersCount++;</span>
                }
<span class="nc" id="L115">                human.humanSemaphore.release();</span>
<span class="nc" id="L116">            }</span>
        }
<span class="nc" id="L118">    }</span>

    public void stopLibrary() {
<span class="nc" id="L121">        logger.info(&quot;Stopping library&quot;);</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">        for (Human human : humans) {</span>
<span class="nc" id="L124">            human.stopHuman();</span>
<span class="nc" id="L125">        }</span>

<span class="nc" id="L127">        shouldEnd = true;</span>
<span class="nc" id="L128">        waitingQueue.clear();</span>
<span class="nc" id="L129">        librarySemaphore.release(humans.size());</span>

<span class="nc" id="L131">        logger.info(&quot;Library stopped&quot;);</span>
<span class="nc" id="L132">    }</span>

    public void requestRead(Reader reader) {
<span class="nc" id="L135">        logger.info(reader.toString() + &quot; requested read&quot;);</span>
<span class="nc" id="L136">        waitingQueue.add(reader);</span>

<span class="nc" id="L138">        librarySemaphore.release();</span>
<span class="nc" id="L139">        reader.humanSemaphore.acquireUninterruptibly();</span>
<span class="nc" id="L140">    }</span>

    public void requestWrite(Writer writer) {
<span class="nc" id="L143">        logger.info(writer.toString() + &quot; requested write&quot;);</span>
<span class="nc" id="L144">        waitingQueue.add(writer);</span>

<span class="nc" id="L146">        librarySemaphore.release();</span>
<span class="nc" id="L147">        writer.humanSemaphore.acquireUninterruptibly();</span>
<span class="nc" id="L148">    }</span>

    public void finishRead(Reader reader) {
<span class="nc" id="L151">        logger.info(reader.toString() + &quot; finished reading&quot;);</span>
<span class="nc" id="L152">        readerAndWriterSemaphore.release();</span>
<span class="nc" id="L153">        readersCount--;</span>

<span class="nc" id="L155">        librarySemaphore.release();</span>
<span class="nc" id="L156">    }</span>

    public void finishWrite(Writer writer) {
<span class="nc" id="L159">        logger.info(writer.toString() + &quot; finished writing&quot;);</span>
<span class="nc" id="L160">        readerAndWriterSemaphore.release(maxReaders);</span>
<span class="nc" id="L161">        writersCount--;</span>

<span class="nc" id="L163">        librarySemaphore.release();</span>
<span class="nc" id="L164">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>